---
 layout:     post
 title:      摄像机公式推导
 subtitle:   Perspective&Ortho
 date:       2019-1-21
 author:     Bob
 header-img: img/post-bg-unity.jpg
 catalog: true
 tags:
     - Unity
---


#### 正交投影

![image](/img/d_10.png)

观察坐标为右手坐标系，NDC使用左手坐标系。观察空间的x_eye、y_eye与z_eye分量都线性映射到NDC。我们只需将长方体缩放为正方体，然后移动它到原点。让我们使用线性关系推导所有元素。

$\frac{x_{eye}-l}{r-l}=\frac{x_{ndc}-(-1)}{1-(-1)} \Rightarrow  x_{ndc}=\frac{2}{r-l}x_{eye}-\frac{r+l}{r-l}$

$\frac{y_{eye}-b}{t-b}=\frac{y_{ndc}-(-1)}{1-(-1)} \Rightarrow  y_{ndc}=\frac{2}{t-b}y_{eye}-\frac{t+b}{t-b}$

$\frac{z_{eye}-(-n)}{-f-(-n)}=\frac{z_{ndc}-(-1)}{1-(-1)} \Rightarrow  z_{ndc}=\frac{-2}{f-n}z_{eye}-\frac{f+n}{f-n}$

投影矩阵:一个缩放和平移矩阵结合。
$\begin{bmatrix}
 \frac{2}{r-l}&0  & 0 & -\frac{r+l}{r-l}\\ 
 0&  \frac{2}{t-b}& 0 & -\frac{t+b}{t-b}\\ 
 0& 0 &  \frac{-2}{f-n}& -\frac{f+n}{f-n}\\ 
 0& 0 & 0 & 1
\end{bmatrix}$

Unity源码实现
```c
Matrix4x4f& Matrix4x4f::SetOrtho (
	float left,
	float right,
	float bottom,
	float top,
	float zNear,
	float zFar )
{
	SetIdentity ();

	float deltax = right - left;
	float deltay = top - bottom;
	float deltaz = zFar - zNear;

	Get(0,0) = 2.0F / deltax;
	Get(0,3) = -(right + left) / deltax;
	Get(1,1) = 2.0F / deltay;
	Get(1,3) = -(top + bottom) / deltay;
	Get(2,2) = -2.0F / deltaz;
	Get(2,3) = -(zFar + zNear) / deltaz;
	return *this;
}
```

#### 透视投影

![image](/img/d_11.png)

在透视投影中，观察坐标中的3D点会被映射到立方体（NDC:Normalized Device Coordinates ）中。x坐标的范围从[l,f]到[-1,1]，y坐标的范围从[b,t]到[-1,1]，z坐标的范围从[n,f]到[-1,1]。


Unity源码实现
```c
Matrix4x4f& Matrix4x4f::SetPerspective(
	float fovy,
	float aspect,
	float zNear,
	float zFar )
{
	float cotangent, deltaZ;
	float radians = Deg2Rad (fovy / 2.0f);
	cotangent = cos (radians) / sin (radians);
	deltaZ = zNear - zFar;
	
	Get (0,0) = cotangent / aspect;	Get (0,1) = 0.0F;      Get (0,2) = 0.0F;                    Get (0,3) = 0.0F;
	Get (1,0) = 0.0F;               Get (1,1) = cotangent; Get (1,2) = 0.0F;                    Get (1,3) = 0.0F;
	Get (2,0) = 0.0F;               Get (2,1) = 0.0F;      Get (2,2) = (zFar + zNear) / deltaZ; Get (2,3) = 2.0F * zNear * zFar / deltaZ;
	Get (3,0) = 0.0F;               Get (3,1) = 0.0F;      Get (3,2) = -1.0F;                   Get (3,3) = 0.0F;

	return *this;
}
```

参考资料：

[gl_projectionmatrix](http://www.songho.ca/opengl/gl_projectionmatrix.html)