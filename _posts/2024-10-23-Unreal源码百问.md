---
 layout:     post
 title:      Unreal源码百问
 subtitle:   Unreal
 date:       2024-10-23
 author:     Bob
 header-img: img/pos_bg_unreal.jpg
 catalog: true
 tags:
     - Unreal
---

简约写的一些读源码笔记，行文胡乱没章法，仅供备忘。

### 1.如何识别引擎和插件DLL编译不匹配？
检查调用堆栈
```c
int32 GuardedMain( const TCHAR* CmdLine )
EnginePreInit( CmdLine );
int32 FEngineLoop::PreInit(const TCHAR* CmdLine)
int32 FEngineLoop::PreInitPreStartupScreen(const TCHAR* CmdLine)
bool FEngineLoop::AppInit( )
ProjectManager.CheckModuleCompatibility(IncompatibleFiles);
PluginManager.CheckModuleCompatibility(IncompatibleFiles, IncompatibleEngineFiles);
FModuleDescriptor::CheckModuleCompatibility(CurrentProject->Modules, OutIncompatibleModules);
ModuleManager.IsModuleUpToDate(Module.Name)
FModuleManifest::TryRead(FileName, Manifest)
```
通过***.modules文件记录编译信息，通过FSimpleParse解析这个文件，格式如下
```c
{
	"BuildId": "488e2f37-bf07-4f46-8a3e-5e5a4141fbac",
	"Modules": 
	{
		"ShootLikeMe": "UnrealEditor-ShootLikeMe.dll",
		"ShootLikeMeEditor": "UnrealEditor-ShootLikeMeEditor.dll"
	}
}
```
FModuleManifest::TryRead中比较BuildId是否匹配，最后ModuleManager.IsModuleUpToDate中检查Modules中的Dll是否存在



### 2.启动项目何时编译c++代码？
如果ide（eg：vs/rider）启动游戏，在启动引擎前就会编译好所有dll文件。
如果不是ide启动，实际调用UBT去处理编译（实际还是调用ide依赖的编译器比如msvc），当然前置会做一些检查工作。
如果Intermediate目录还在，Binaries删了，应该是只有链接过程，很快就能在Binaries下生成dll。
如果编译的dll版本不匹配会提示：The following modules are missing or built with a different engine version

ProjectManager.CheckModuleCompatibility和PluginManager.CheckModuleCompatibility检查dll版本不匹配或者不存在就会启动编译
编译主要逻辑在DesktopPlatformWindows.cpp，实际是调用的RunUnrealBuildTool来编译

```c
int32 FEngineLoop::PreInitPreStartupScreen(const TCHAR* CmdLine)
bool bCompileResult = FDesktopPlatformModule::Get()->CompileGameProject(FPaths::RootDir(), FPaths::GetProjectFilePath(), Context, &CompilationResult);
FFeedbackContextMarkup::PipeProcessOutput(Description, UnrealBuildToolPath, Arguments, Warn, &OutExitCode) && OutExitCode == 0;
```

启动UBT的参数例如："E:/Dev_5.4/Editor/Engine/Build/BatchFiles/Build.bat Development Win64 -Project="E:/Dev_5.4/Project/****/****.uproject" -TargetType=Editor -Progress -NoEngineChanges -NoHotReloadFromIDE"

UnrealTargetPlatform：Win64 Mac IOS Android Linux
UnrealTargetConfiguration： Debug DebugGame Development Test Shipping

最后调用dotnet Engine\Binaries\DotNET\UnrealBuildTool\UnrealBuildTool.dll

UnrealBuildTool.exe参数
```c
Global options:                                                                                                                                                  
  -Help                :  Display this help.                                                                                                                     
  -Verbose             :  Increase output verbosity                                                                                                              
  -VeryVerbose         :  Increase output verbosity more                                                                                                         
  -Log                 :  Specify a log file location instead of the default Engine/Programs/UnrealBuildTool/Log.txt                                             
  -TraceWrites         :  Trace writes requested to the specified file                                                                                           
  -Timestamps          :  Include timestamps in the log                                                                                                          
  -FromMsBuild         :  Format messages for msbuild                                                                                                            
  -SuppressSDKWarnings :  Missing SDKs error verbosity level will be reduced from warning to log                                                                 
  -Progress            :  Write progress messages in a format that can be parsed by other programs                                                               
  -NoMutex             :  Allow more than one instance of the program to run at once                                                                             
  -WaitMutex           :  Wait for another instance to finish and then start, rather than aborting immediately                                                   
  -RemoteIni           :  Remote tool ini directory                                                                                                              
  -Mode=               :  Select tool mode. One of the following (default tool mode is "Build"):                                                                 
                            AggregateClangTimingInfo, AggregateParsedTimingInfo, Analyze, ApplePostBuildSync, Build,                                             
                            ClRepro, Clean, Deploy, Execute, FixIncludePaths, GenerateClangDatabase, GenerateProjectFiles,                                       
                            IOSPostBuildSync, IWYU, InlineGeneratedCpps, JsonExport, PVSGather, ParseMsvcTimingInfo,                                             
                            PipInstall, PrintBuildGraphInfo, ProfileUnitySizes, Query, QueryTargets, Server, SetupPlatforms,                                     
                            Test, UnrealHeaderTool, ValidatePlatforms, WriteDocumentation, WriteMetadata                                                         
  -Clean               :  Clean build products. Equivalent to -Mode=Clean                                                                                        
  -ProjectFiles        :  Generate project files based on IDE preference. Equivalent to -Mode=GenerateProjectFiles                                               
  -ProjectFileFormat=  :  Generate project files in specified format. May be used multiple times.                                                                
  -Makefile            :  Generate Linux Makefile                                                                                                                
  -CMakefile           :  Generate project files for CMake                                                                                                       
  -QMakefile           :  Generate project files for QMake                                                                                                       
  -KDevelopfile        :  Generate project files for KDevelop                                                                                                    
  -CodeliteFiles       :  Generate project files for Codelite                                                                                                    
  -XCodeProjectFiles   :  Generate project files for XCode                                                                                                       
  -EddieProjectFiles   :  Generate project files for Eddie                                                                                                       
  -VSCode              :  Generate project files for Visual Studio Code                                                                                          
  -VSMac               :  Generate project files for Visual Studio Mac                                                                                           
  -CLion               :  Generate project files for CLion                                                                                                       
  -Rider               :  Generate project files for Rider   
```

可看出生成uproject也是UnrealBuildTool操办。

UnrealBuildTool是个C#工程
E:\Dev_5.4\Editor\Engine\Source\Programs\UnrealBuildTool

编译日志：C:\Users\happyelements\AppData\Local\UnrealBuildTool\Log.txt


Compiler: C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\14.38.33130\bin\Hostx64\x64\cl.exe
Linker: C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\14.38.33130\bin\Hostx64\x64\link.exe
Library Manager: C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\14.38.33130\bin\Hostx64\x64\lib.exe


UnrealBuildTool Building Log堆栈
```c
private static int Main(string[] ArgumentsArray)
ToolMode Mode = (ToolMode)Activator.CreateInstance(ModeType)!;
Result = Mode.ExecuteAsync(Arguments, Logger).GetAwaiter().GetResult();
	BuildConfiguration BuildConfiguration = new BuildConfiguration();
			XmlConfig.ApplyTo(BuildConfiguration);
			Arguments.ApplyTo(BuildConfiguration);

await BuildAsync(TargetDescriptors, BuildConfiguration, WorkingSet, Options, WriteOutdatedActionsFile, Logger, bSkipPreBuildTargets);
TargetMakefile NewMakefile = await CreateMakefileAsync(BuildConfiguration, TargetDescriptors[Idx], WorkingSet, Logger);
Target = UEBuildTarget.Create(TargetDescriptor, BuildConfiguration, Logger);
public void PreBuildSetup(ILogger Logger)
Logger.LogDebug("Building {AppName} - {TargetName} - {Platform} - {Configuration}", AppName, TargetName, Platform, Configuration);
```

### 启动项目何时编译蓝图？


### 启动项目何时检查资源？
