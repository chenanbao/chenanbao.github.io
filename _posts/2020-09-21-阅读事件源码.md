---
 layout:     post
 title:      阅读UGUI源码
 subtitle:   事件机制
 date:       2020-09-21
 author:     Bob
 header-img: img/post-bg-unity.jpg
 catalog: true
 tags:
     - C#
---


##### [Selectable]

Button/Dropdown/InputField/Scrollbar/Slider/Toggle都是继承Selectable实现，Transition实现状态间切换。

```c
public class Selectable
        :
        UIBehaviour,
        IMoveHandler,
        IPointerDownHandler, IPointerUpHandler,
        IPointerEnterHandler, IPointerExitHandler,
        ISelectHandler, IDeselectHandler
    {}

protected enum SelectionState
{
    Normal,
    Highlighted,
    Pressed,
    Disabled
}

public enum Transition
{
    None,
    ColorTint,
    SpriteSwap,
    Animation
}
```

##### [EventSystem]

EventSystem管理所有BaseInputModule，系统支持且激活启用的Module被调用Process，PointerEventData和Raycast的结果传给Module去处理，BaseInputModule通知具体的IEventSystemHandler进行逻辑处理（ExecuteEvents）。

EventData：
BaseEventData实现AbstractEventData
PointerEventData：点击触摸相关数据
AxisEventData:移动方向和量

##### [StandaloneInputModule]

StandaloneInputModule->PointerInputModule->BaseInputModule

ProcessMouseEvent:鼠标左中右键处理ProcessMousePress，ProcessMove，ProcessDrag
ProcessTouchEvents:多点触摸处理ProcessTouchPress，ProcessMove，ProcessDrag

均产生PointerEventData符合条件的交予ExecuteEvents执行事件。

##### [Raycasters]

射线捕获对象处理流程：
1.StandaloneInputModule.Process()
2.StandaloneInputModule.ProcessTouchEvents()
3.PointerInputModule.GetTouchPointerEventData()
  eventSystem.RaycastAll(pointerData, m_RaycastResultCache)
4.BaseRaycaster.Raycast(eventData, raycastResults)
  通过位置信息获取射线,接着获取最近的距离数据hitDistance
  ray = currentEventCamera.ScreenPointToRay(eventPosition)
  ReflectionMethodsCache.Singleton.raycast3DAll
  ReflectionMethodsCache.Singleton.getRayIntersectionAll
  遍历所有Graphics
  Raycast(canvas, currentEventCamera, eventPosition, canvasGraphics, m_RaycastResults)
  返回射线检测结果results
  graphic.Raycast(pointerPosition, eventCamera)


##### [EventSystemHandler]

事件处理者，需要触发哪个事件就实现哪个接口

##### [ExecuteEvents]

事件执行